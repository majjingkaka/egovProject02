<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:security="http://www.springframework.org/schema/security"
	xmlns:egov-security="http://maven.egovframe.go.kr/schema/egov-security"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd
        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd
		http://maven.egovframe.go.kr/schema/egov-security http://maven.egovframe.go.kr/schema/egov-security/egov-security-4.2.0.xsd">

<!--
수정일               수정자			수정내용
==========   ============	=================================================
2011.09.07   서준식                   일반, 업무사용자의 경우 조직아이디가 없어 로그인이 안되던 문제 수정(SQL 수정)
2011.09.25   서준식                   usersByUsernameQuery 쿼리의 조직 아이디 비교 부분  오류 수정 > alias 추가
2014.06.13   Vincent Han    표준프레임워크 3.0 적용 (간소화 설정 사용)
2017.07.10   장동한                   실행행환경 v3.7 적용[보안기능 추가(sniff, xFrameOptions, xssProtection csrf)]
2018.10.26   신용호                   실행행환경 v3.8 적용
2020.08.28   정진오                   표준프레임워크 v3.10 개선
2023.12.20   정진오                   표준프레임워크 v4.2 개선(SpEL(use-expressions) 설정 추가)
-->

	<security:http pattern="/css/**" security="none"/>
	<security:http pattern="/html/**" security="none"/>
    <security:http pattern="/images/**" security="none"/>
 	<security:http pattern="/js/**" security="none"/>
 	<security:http pattern="/resource/**" security="none"/>
 	<security:http pattern="/se2/**" security="none"/>
 	<security:http pattern="/se2823/**" security="none"/>
 	<security:http pattern="/se2upload/**" security="none"/>
 	<security:http pattern="/upload/**" security="none"/>
 	<security:http pattern="/imagePath/**" security="none" />
 	<security:http pattern="\A/WEB-INF/tiles/.*\Z" security="none" auto-config="true" use-expressions="true" />
 	<security:http pattern="\A/WEB-INF/jsp/.*\Z" request-matcher="regex" security="none" auto-config="true" use-expressions="true" />
	
	<security:http pattern="/bible/**" auto-config="true" use-expressions="true" /><!-- authentication-manager-ref="userJdbcUserManager" -->
		<!-- <security:csrf disabled="true"/> -->
		<!-- <security:intercept-url pattern="/bible/**" access="permitAll"/> -->
	<!-- </security:http> -->
	
	<!-- 
	<security:http pattern="/bible/**" auto-config="true" use-expressions="true">authentication-manager-ref="userJdbcUserManager"
		<security:csrf disabled="true"/>
		<security:intercept-url pattern="/bible/**" access="permitAll"/>
		
		<security:access-denied-handler ref="cnportalAccessDenied"/>
        <security:form-login login-page="/bible/bibleLogin/login.do"
                login-processing-url="/bible/bibleLogin/toLogin.do"
                username-parameter="username"
                password-parameter="password"
                authentication-success-handler-ref="bibleSessionSavedRequestAwareAuthenticationHandler"
                authentication-success-forward-url="/bible/main.do"
                authentication-failure-handler-ref="bibleLoginHistoryAuthenticationFailureHandler"
                authentication-failure-url="/bible/bibleLogin/login.do"
                default-target-url="/bible/main.do"/>
        <security:logout logout-url="/bible/bibleLogin/logout.do"
        		success-handler-ref="cnportalLogoutSuccessHandler"
                />
                
        <security:session-management session-fixation-protection="migrateSession">
        	<security:concurrency-control max-sessions="1" expired-url="/bible/main.do"/> 중복 로그인 방지
		</security:session-management>
	</security:http>
 	
 	<bean id="cnportalAccessDenied" class="egovframework.com.bible.service.member.sec.BibleAccessDeniedHandler">
    	<property name="defaultErrorPage" value="/errors/403" />
    	<property name="siteId" value="bible" />
    </bean>
    <bean id="cnportalLogoutSuccessHandler" class="egovframework.com.bible.service.member.sec.BibleLogoutSuccessHandler">
    	<property name="defaultTargetUrl" value="/bible/main.do" />
    	<property name="siteId" value="bible" />
    </bean>
    <bean id="bibleSessionSavedRequestAwareAuthenticationHandler" class="egovframework.com.bible.service.member.sec.SessionSavedRequestAwareAuthenticationHandler">
    	<property name="defaultTargetUrl" value="/bible/main.do" />
    </bean>
    
    <bean id="bibleLoginHistoryAuthenticationFailureHandler" class="egovframework.com.bible.service.member.sec.LoginHistoryAuthenticationFailureHandler">
    	<property name="defaultFailureUrl" value="/bible/bibleLogin/login.do" />
    </bean>
    
 	<security:authentication-manager id="userJdbcUserManager">
        <security:authentication-provider user-service-ref="jdbcUserService">
			<security:password-encoder ref="passwordEncoder" />
		</security:authentication-provider>
    </security:authentication-manager>
    
    <bean name="passwordEncoder" class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder" />
    
    <bean id="jdbcUserService" class="egovframework.com.bible.service.member.sec.BibleJdbcUserDetailsManager" >
        <property name="usersByUsernameQuery" value="
			select user_id as username
					, password as password
					, user_nm
					, user_emad
					, user_cpno
					, author_cd
			from bible_user_info
			where user_id = ?
  		"/>
        <property name="authoritiesByUsernameQuery" value="
			select user_id, author_cd as authority
			from bible_user_info
			where user_id = ?
        "/>
        <property name="hierarchicalRolesQuery" value="
       		select a.chldrn_author_cd as child, a.parnts_author_cd as parent
			from bible_author_sclsrt a left join bible_author_sclsrt b on (a.chldrn_author_cd = b.parnts_author_cd)
		"/>
        <property name="mapper" ref="bibleUserMapping"/>
        <property name="dataSource" ref="egov.dataSource"/>
    </bean>
    
    
    <bean id="bibleUserMapping" class="egovframework.com.bible.service.member.sec.BibleUserMapping" />
     -->
    
    
    
    
    
	<!-- <security:http pattern="\A/sym/mnu/mpm/.*\.do.*\Z" security="none"/> -->
	<!-- 패스워드 저장 방식 (sha-256, plaintext, sha, md5, bcrypt) -->
	
	
    <egov-security:config id="securityConfig"
		loginUrl="/bible/bibleLogin/login.do"
		logoutSuccessUrl="/bible/bibleLogin/login.do"
		loginFailureUrl="/bible/bibleLogin/login.do?login_error=1"
		accessDeniedUrl="/sec/ram/accessDenied.do"

		dataSource="egov.dataSource"
		jdbcUsersByUsernameQuery="SELECT USER_ID, ESNTL_ID AS PASSWORD, 1 ENABLED, USER_NM, USER_ZIP,
                                                              USER_ADRES, USER_EMAIL, USER_SE, ORGNZT_ID, ESNTL_ID,
                                                              (select a.ORGNZT_NM from COMTNORGNZTINFO a where a.ORGNZT_ID = m.ORGNZT_ID) ORGNZT_NM
                                                       FROM COMVNUSERMASTER m WHERE CONCAT(USER_SE, USER_ID) = ?"
		jdbcAuthoritiesByUsernameQuery="SELECT A.SCRTY_DTRMN_TRGET_ID USER_ID, A.AUTHOR_CODE AUTHORITY
                                                             FROM COMTNEMPLYRSCRTYESTBS A, COMVNUSERMASTER B
                                                             WHERE A.SCRTY_DTRMN_TRGET_ID = B.ESNTL_ID AND B.USER_ID = ?"
		jdbcMapClass="egovframework.com.sec.security.common.EgovSessionMapping"

		requestMatcherType="regex"
		hash="plaintext"
		hashBase64="false"

		concurrentMaxSessons="1"
		concurrentExpiredUrl="/bible/main.do"
		errorIfMaximumExceeded="false"

		defaultTargetUrl="/bible/main.do"
		alwaysUseDefaultTargetUrl="true"

		sniff="true"
		xframeOptions="SAMEORIGIN" 
		xssProtection="true" 
		cacheControl="false"
		csrf="true"
		csrfAccessDeniedUrl="/egovCSRFAccessDenied.do"
	/>

	<egov-security:secured-object-config id="securedObjectConfig"
		sqlHierarchicalRoles="
			SELECT a.CHLDRN_ROLE as child, a.PARNTS_ROLE parent
			FROM COMTNROLES_HIERARCHY a LEFT JOIN COMTNROLES_HIERARCHY b on (a.CHLDRN_ROLE = b.PARNTS_ROLE)"
		sqlRolesAndUrl="
			SELECT a.ROLE_PTTRN url, b.AUTHOR_CODE authority
			FROM COMTNROLEINFO a, COMTNAUTHORROLERELATE b
			WHERE a.ROLE_CODE = b.ROLE_CODE
				AND a.ROLE_TY = 'url'  ORDER BY a.ROLE_SORT"
		sqlRolesAndMethod="
			SELECT a.ROLE_PTTRN as 	&quot;method&quot;, b.AUTHOR_CODE authority
			FROM COMTNROLEINFO a, COMTNAUTHORROLERELATE b
			WHERE a.ROLE_CODE = b.ROLE_CODE
			AND a.ROLE_TY = 'method'  ORDER BY a.ROLE_SORT"
		sqlRolesAndPointcut="
			SELECT a.ROLE_PTTRN pointcut, b.AUTHOR_CODE authority
			FROM COMTNROLEINFO a, COMTNAUTHORROLERELATE b
			WHERE a.ROLE_CODE = b.ROLE_CODE
			AND a.ROLE_TY = 'pointcut'  ORDER BY a.ROLE_SORT"
		sqlRegexMatchedRequestMapping="
			SELECT a.ROLE_PTTRN uri, b.AUTHOR_CODE authority
			FROM COMTNROLEINFO a, COMTNAUTHORROLERELATE b
			WHERE a.ROLE_CODE = b.ROLE_CODE
			AND a.ROLE_TY = 'regex'  
			ORDER BY a.ROLE_SORT"
	/>

	<egov-security:initializer id="initializer" supportMethod="true" supportPointcut="false" />

    <!-- URL에 세미콜론(semicolon)허용 여부(기본값/false) -->
	<!-- 
	<bean id="egovStrictHttpFirewall" class="org.springframework.security.web.firewall.StrictHttpFirewall">
		<property name="allowSemicolon" value="true"/>
	</bean>
	<security:http-firewall ref="egovStrictHttpFirewall"/>
	-->

</beans>
